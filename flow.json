[{"id":"2e299254.21ad6e","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"2135ef5d.634de","type":"sqlitedb","z":"","db":"/tmp/sqlite","mode":"RWC"},{"id":"a2a22835.7fe9e8","type":"sqlitedb","z":"","db":"/home/pi/Documents/blockchainlist","mode":"RWC"},{"id":"d9a7944f.e4c788","type":"rpi-sensehat in","z":"2e299254.21ad6e","name":"Temperature","motion":false,"env":true,"stick":false,"x":75,"y":254.28570699691772,"wires":[["b40a505c.5337d"]]},{"id":"1a17e554.dac36b","type":"function","z":"2e299254.21ad6e","name":"CONVERT","func":"var input = msg.payload\nvar array = msg.payload.split(\"\\n\")\nvar date = array[0]\nvar temperature = array[1]\nvar mac = array[2]\nvar macSender = array[3]\nvar macBlack = '\"b8:27:eb:0c:d2:ec\"'\n\nvar newMsg = {\n    \"payload\" :{\n        \"date\": date,\n        \"temperature\": temperature,\n        \"MAC\": mac\n    },\n    \"topic\": 'INSERT INTO blockchainlist(currentdate, temperature, MAC) values ('+date+','+temperature+','+mac+')'\n};\n\n// Import the global Crypto-js module defined on Node-Red settings.js file\nvar cryptojs = context.global.cryptojs;\n// Move data to base64\nvar bdata = new Buffer(msg.payload).toString('base64');\n// Encrypt the data with the device key.\nvar ciphertext = cryptojs.HmacSHA256(bdata, 'secret key clear');\n\n// The payload is now the encrypted data\nvar hashVal = \"\\\"\"+ciphertext.toString()+\"\\\"\"\nvar hash = {\n    \"payload\" :{\n        \"hash\": ciphertext.toString()\n    },\n    \"topic\": 'INSERT INTO blockchainlist(hash) values ('+hashVal+')'\n}\n\nif( macSender == macBlack ) { \n    return [newMsg, hash]; }","outputs":2,"noerr":0,"x":509.28577423095703,"y":153.2142972946167,"wires":[["6ccd9850.3feef8"],["57c369e7.b644b8"]],"outputLabels":["Database","Hash"]},{"id":"6ccd9850.3feef8","type":"debug","z":"2e299254.21ad6e","name":"DATABASE OUT","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1047.428596496582,"y":90.85715198516846,"wires":[]},{"id":"9c4db387.f7e86","type":"inject","z":"2e299254.21ad6e","name":"CREATE","topic":"CREATE TABLE blockchainlist(id INTEGER PRIMARY KEY AUTOINCREMENT, hash TEXT)","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":257.1428642272949,"y":52.857154846191406,"wires":[["57c369e7.b644b8"]]},{"id":"57c369e7.b644b8","type":"sqlite","z":"2e299254.21ad6e","mydb":"a2a22835.7fe9e8","sqlquery":"msg.topic","sql":"","name":"Database","x":700.0001220703125,"y":66.14287757873535,"wires":[[]]},{"id":"ac8a069.15c5bf8","type":"rpi-sensehat out","z":"2e299254.21ad6e","name":"","x":587.5714530944824,"y":481.4285774230957,"wires":[]},{"id":"b40a505c.5337d","type":"delay","z":"2e299254.21ad6e","name":"Delay","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":208.1428451538086,"y":209.5,"wires":[["1bd60a4a.f4a596","2881d674.d7531a"]]},{"id":"d963537b.d43d","type":"function","z":"2e299254.21ad6e","name":"hatout","func":"var newMsg = {\n    \"payload\" :\n        '0,0,green'\n   };\nflow.set(\"X\", 0, \"Y\", 0);\nreturn newMsg;","outputs":1,"noerr":0,"x":289.0000286102295,"y":480.35711765289307,"wires":[["ac8a069.15c5bf8"]]},{"id":"9af24af0.e592f8","type":"inject","z":"2e299254.21ad6e","name":"","topic":"","payload":"hatout","payloadType":"flow","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":107.5000228881836,"y":481.60711669921875,"wires":[["d963537b.d43d"]]},{"id":"24d0ab84.ab4f74","type":"function","z":"2e299254.21ad6e","name":"stick","func":"\nvar X = flow.get(\"X\")||0;\n\nvar Y = flow.get(\"Y\")||0;\nvar newmsg;\nif(msg.payload.key=='DOWN'&msg.payload.state==1){\n\n\n\n\n\n    if(X<7)\n    {\n        newmsg = {\n        \"payload\" : X+','+Y+',off,'+(X+1)+','+Y+',blue'\n        }\n        X+=1;\n        flow.set(\"X\", X);\n    }\n}\n\nif(msg.payload.key=='UP'&msg.payload.state==1){\n    if(X>0)\n    {\n        newmsg = {\n        \"payload\" : X+','+Y+',off,'+(X-1)+','+Y+',green'\n        }\n        X-=1;\n        flow.set(\"X\", X);\n    }\n}\n\nif(msg.payload.key=='RIGHT'&msg.payload.state==1){\n    if(Y>0)\n    {\n        newmsg = {\n        \"payload\" : X+','+Y+',off,'+X+','+(Y-1)+',red'\n        }\n        Y-=1;\n        flow.set(\"Y\", Y);\n    }\n}\n\nif(msg.payload.key=='LEFT'&msg.payload.state==1){\n    if(Y<7)\n    {\n        newmsg = {\n        \"payload\" : X+','+Y+',off,'+X+','+(Y+1)+',yellow'\n        }\n        Y+=1;\n        flow.set(\"Y\", Y);\n    }\n}\n\nif(msg.payload.key=='ENTER'&msg.payload.state==1){\n    \n        newmsg = {\n        \"payload\" : '*,*,off'\n        }\n    flow.set(\"X\", 0);\n    flow.set(\"Y\", 0);\n    \n}\n\nreturn newmsg;","outputs":1,"noerr":0,"x":262.8928451538086,"y":593.5713758468628,"wires":[["ac8a069.15c5bf8"]]},{"id":"b942010c.01f16","type":"rpi-sensehat in","z":"2e299254.21ad6e","name":"","motion":false,"env":false,"stick":true,"x":95.35712759835383,"y":593.5713221686227,"wires":[["24d0ab84.ab4f74"]]},{"id":"43212e63.f8f66","type":"inject","z":"2e299254.21ad6e","name":"","topic":"","payload":"R90","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"","x":125.92857360839844,"y":407.8571491241455,"wires":[["ac8a069.15c5bf8"]]},{"id":"9cb7fa75.2ddd18","type":"udp out","z":"2e299254.21ad6e","name":"UDP OUT","addr":"192.168.1.0","iface":"","port":"2345","ipv":"udp4","outport":"2345","base64":false,"multicast":"multi","x":866.5001373291016,"y":328.7500352859497,"wires":[]},{"id":"1bd60a4a.f4a596","type":"function","z":"2e299254.21ad6e","name":"temperature","func":"var datenow = Date.now();\nvar tempInput = msg.payload;\ndatenow = datenow.toString();\ntemperaturenow = tempInput.temperature.toString();\nvar mac = '\"b8:27:eb:97:fd:69\"';\n\nvar newMsg = {\n    \"payload\" :{\n        \"date\": datenow,\n        \"temperature\": temperaturenow,\n        \"MAC\": mac,\n        \"MACsender\": mac\n    },\n    //\"topic\": \"INSERT INTO blockchainlist(currentdate, temperature) values ( \" + datenow + \", \" + tempInput.temperature + \")\"\n      \"topic\": 'INSERT INTO blockchainlist(currentdate, temperature, MAC) values ('+datenow+','+tempInput.temperature+','+mac+')'\n\n        };\nreturn newMsg;","outputs":1,"noerr":0,"x":343.2717170715332,"y":264.2630424499512,"wires":[["78c408b1.d67138"]]},{"id":"6b3ee3b3.b22fcc","type":"udp in","z":"2e299254.21ad6e","name":"","iface":"","port":"2345","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":741.4800453186035,"y":572.3872089385986,"wires":[[]]},{"id":"8f806be0.e2b8a8","type":"debug","z":"2e299254.21ad6e","name":"TEST","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":852.9106140136719,"y":435.51304054260254,"wires":[]},{"id":"78c408b1.d67138","type":"split","z":"2e299254.21ad6e","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":553.7430725097656,"y":317.0069694519043,"wires":[["1806b2e0.33336d"]]},{"id":"1806b2e0.33336d","type":"join","z":"2e299254.21ad6e","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":701.7465515136719,"y":388.9687614440918,"wires":[["8f806be0.e2b8a8","9cb7fa75.2ddd18"]]},{"id":"cf6ad8db.8bd958","type":"udp in","z":"2e299254.21ad6e","name":"UDP IN","iface":"","port":"2346","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":297.98716735839844,"y":116.70139503479004,"wires":[["1a17e554.dac36b"]]},{"id":"2881d674.d7531a","type":"function","z":"2e299254.21ad6e","name":"scrollTemp","func":"var tempInput = msg.payload;\nmsg.payload = tempInput.temperature;\nvar newMsg = {\n    \"payload\" :\n    msg.payload\n    \n};\nreturn newMsg;","outputs":1,"noerr":0,"x":323.9843940734863,"y":371.215295791626,"wires":[["ac8a069.15c5bf8"]]}]